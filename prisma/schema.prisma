generator client {
  provider = "prisma-client-js"
  binaryTargets = ["native"]
}

datasource db {
  provider = "mysql"
  url      = env("DATABASE_URL")
}

model Province {
  id_province   Int @id @default(autoincrement())
  name          String @unique @db.VarChar(50)

  addresses Address[]
}

model Address {
  id_address      Int @id @default(autoincrement())
  street          String @db.VarChar(150)
  number          String @db.VarChar(10)
  portal          String? @db.VarChar(10)
  floor           String? @db.VarChar(10)
  door            String? @db.VarChar(10)
  municipality    String @db.VarChar(150)
  postal_code     String @db.VarChar(10)

  // FK
  id_province   Int
  province      Province @relation(fields: [id_province], references: [id_province])

  clients       Client[]
  suppliers     Supplier[]
  employees     Employee[]
  warehouses    Warehouse[]
}

model Client {
  id_client Int @id @default(autoincrement())

  firstName String @db.VarChar(100)
  lastName  String @db.VarChar(150)
  phone     String @db.VarChar(20)
  email     String @unique @db.VarChar(100)
  active    Boolean @default(true)

  id_address Int
  address   Address @relation(fields: [id_address], references: [id_address])

  clientOrders  ClientOrder[]
}

model Supplier {
  id_supplier   Int @id @default(autoincrement())
  name          String @db.VarChar(100)
  phone         String @db.VarChar(20)
  email         String @unique @db.VarChar(100)
  active        Boolean @default(true)

  id_address    Int
  address       Address @relation(fields: [id_address], references: [id_address])

  supplierProducts  SupplierProduct[]
  supplierOrders    SupplierOrder[]
}

model Department {
  id_department   Int @id @default(autoincrement())
  name            String @unique @db.VarChar(100)
  desc            String? @db.VarChar(250)

  employees       Employee[]
}

model Employee {
  id_employee   Int @id @default(autoincrement())
  firstName     String @db.VarChar(100)
  lastName      String @db.VarChar(150)
  phone         String @db.VarChar(20)
  email         String @unique @db.VarChar(100)
  job_title     String @db.VarChar(100)
  hire_date     DateTime
  base_salary   Decimal @db.Decimal(10,2)
  active        Boolean @default(true)

  id_address     Int
  address       Address @relation(fields: [id_address], references: [id_address])

  id_department Int
  department    Department @relation(fields: [id_department], references: [id_department])

  payrolls      Payroll[]
}

model Payroll {
  id_payroll      Int @id @default(autoincrement())
  period          String @db.VarChar(7)
  base_salary     Decimal @db.Decimal(10,2)
  overtime_hours  Decimal? @db.Decimal(6,2)
  deductions      Decimal @db.Decimal(10,2)
  taxes           Decimal @db.Decimal(10,2)
  net_salary      Decimal @db.Decimal(10,2)
  payment_date    DateTime

  id_employee   Int
  employee      Employee @relation(fields:[id_employee], references: [id_employee])
}

model SupplierProduct {
  id_supplier_product Int @id @default(autoincrement())
  name                String @db.VarChar(100)
  purchase_price      Decimal @db.Decimal(10,2)
  description         String? @db.VarChar(250)   
  active              Boolean @default(true)

  id_supplier         Int
  supplier            Supplier @relation(fields: [id_supplier], references: [id_supplier])     

  supplierOrderItems  SupplierOrderItem[]
  products            Product[]
  @@unique([id_supplier, name])      

  inventories         SupplierProductInventory[]

  @@map("SUPPLIER_PRODUCT")
}

enum OrderStatus {
  PENDING
  CONFIRMED
  RECEIVED
  CANCELLED
}

model SupplierOrder {
  id_supplier_order       Int @id @default(autoincrement())
  created_at              DateTime @default(now())
  updated_at              DateTime @updatedAt
  expected_delivery_date  DateTime?
  status                  OrderStatus @default(PENDING)
  total                   Decimal @db.Decimal(10,2) @default(0)
  active                  Boolean @default(true)

  id_supplier       Int
  supplier          Supplier @relation(fields: [id_supplier], references: [id_supplier])

  items             SupplierOrderItem[]
}

model SupplierOrderItem {
  id_supplier_order_item  Int @id @default(autoincrement())
  quantity                Int
  unit_price              Decimal @db.Decimal(10,2)
  subtotal                Decimal @db.Decimal(10,2)

  id_supplier_order        Int
  supplier_order           SupplierOrder @relation(fields: [id_supplier_order],references: [id_supplier_order])

  id_supplier_product      Int
  supplier_product         SupplierProduct @relation(fields: [id_supplier_product],references: [id_supplier_product])

  @@unique ([id_supplier_order, id_supplier_product])
}

model Product {
  id_product    Int @id @default(autoincrement())
  name          String @db.VarChar(100)
  price         Decimal @db.Decimal(10,2)
  description   String? @db.VarChar(250)
  active        Boolean @default(true)

  id_supplier_product   Int
  supplierProduct       SupplierProduct @relation(fields: [id_supplier_product], references: [id_supplier_product])

  @@unique([name, id_supplier_product])

  inventories         ProductInventory[]
  clientOrderItems    ClientOrderItem[]
}

enum WarehouseType {
  MAIN
  SECONDARY
  DISTRIBUTION
  STORE
}

model Warehouse {
  id_warehouse    Int @id @default(autoincrement())
  name            String @db.VarChar(100)
  warehouse_type  WarehouseType @default(MAIN)
  capacity        Int
  active          Boolean @default(true)

  id_address      Int
  address         Address @relation(fields: [id_address], references:Â [id_address])

  @@unique([id_address, name])

  supplierProductInventories SupplierProductInventory[]
  productInventories         ProductInventory[]
  shipments                  Shipment[]
}

model SupplierProductInventory {
  current_stock   Int 
  max_stock       Int
  min_stock       Int
  last_updated    DateTime @updatedAt
  active          Boolean @default(true)

  id_supplier_product Int
  supplierProduct     SupplierProduct @relation(fields: [id_supplier_product], references: [id_supplier_product])

  id_warehouse        Int
  warehouse           Warehouse @relation(fields: [id_warehouse], references: [id_warehouse])

  @@id([id_supplier_product, id_warehouse])
}

model ProductInventory {
  current_stock   Int 
  max_stock       Int
  min_stock       Int
  last_updated    DateTime @updatedAt
  active          Boolean @default(true)

  id_product  Int
  product     Product @relation(fields: [id_product], references: [id_product])

  id_warehouse        Int
  warehouse           Warehouse @relation(fields: [id_warehouse], references: [id_warehouse])

  @@id([id_product, id_warehouse])
}

enum ShipmentStatus {
  PENDING
  IN_TRANSIT
  DELIVERED
  CANCELLED
}

model Shipment {
  id_shipment               Int @id @default(autoincrement())
  shipping_company          String @db.VarChar(100)
  shipping_cost             Decimal @db.Decimal(10,2)
  status                    ShipmentStatus @default(PENDING)
  shipment_date             DateTime?
  estimated_delivery_date   DateTime?
  actual_delivery_date      DateTime?

  id_warehouse              Int
  warehouse                 Warehouse @relation(fields: [id_warehouse], references: [id_warehouse])

  clientOrders              ClientOrder[]
}

model ClientOrder {
  id_client_order         Int @id @default(autoincrement())
  created_at              DateTime @default(now())
  updated_at              DateTime @updatedAt
  expected_delivery_date  DateTime?
  status                  OrderStatus @default(PENDING)
  total                   Decimal @db.Decimal(10,2) @default(0)

  id_client       Int
  client          Client @relation(fields: [id_client], references: [id_client])

  id_shipment     Int?
  shipment        Shipment? @relation(fields: [id_shipment], references: [id_shipment])

  items           ClientOrderItem[]
}

model ClientOrderItem {
  id_client_order_item    Int @id @default(autoincrement())
  quantity                Int
  unit_price              Decimal @db.Decimal(10,2)
  subtotal                Decimal @db.Decimal(10,2)

  id_client_order        Int
  client_order           ClientOrder @relation(fields: [id_client_order], references: [id_client_order])

  id_product      Int
  product                Product @relation(fields: [id_product], references: [id_product])

  @@unique ([id_client_order, id_product])
}